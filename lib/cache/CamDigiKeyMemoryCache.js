'use strict';const a2_0x536c2f=a2_0x4899;(function(_0x3289c6,_0x373103){const _0x56cad5=a2_0x4899,_0x4fead7=_0x3289c6();while(!![]){try{const _0x53b2f2=parseInt(_0x56cad5(0x1a1))/0x1+-parseInt(_0x56cad5(0x188))/0x2*(parseInt(_0x56cad5(0x19f))/0x3)+-parseInt(_0x56cad5(0x186))/0x4+-parseInt(_0x56cad5(0x181))/0x5+-parseInt(_0x56cad5(0x191))/0x6*(-parseInt(_0x56cad5(0x197))/0x7)+parseInt(_0x56cad5(0x17b))/0x8*(-parseInt(_0x56cad5(0x196))/0x9)+parseInt(_0x56cad5(0x187))/0xa;if(_0x53b2f2===_0x373103)break;else _0x4fead7['push'](_0x4fead7['shift']());}catch(_0xe7d6b2){_0x4fead7['push'](_0x4fead7['shift']());}}}(a2_0x5124,0x5d39e));function a2_0x5124(){const _0x5d0028=['4936UlegRd','cert_chain_str','next','_trustedRootCert','cert_chain','_signerCertificate','1083630WRahPf','CAMDIGIKEY_CLIENT_KEYSTORE_FILE_PASSWORD','push','application/json','getTime','1447620YurGcP','13058700GvKDBX','8852WcsbNG','crypto','ACCESS_TOKEN_CERT_URL','split','getCertificateFromCamDigiKey','request','publicKey','parse','X509Certificate','84576zyTMRu','length','../error/InvalidCertificateChainError','value','default','10332cYOzNm','224bSGpiM','CAMDIGIKEY_API','insert','../api','compareTwoPrincipals','findOne','signerCertificate','then','258JMIrBg','readFileSync','292495XKAIEZ','verifyCertificateChain','statusCode','CAMDIGIKEY_CLIENT_KEYSTORE_FILE','verify','camdigikey-cache','message','subject','signer_cert','env','Invalid\x20certificate\x20chain\x20validation\x20of\x20signer\x20certificate','validTo','done','__awaiter','Error\x20requesting\x20to\x20CamDigiKey\x20Server.','data','_db','agentOptions','addCollection','get','assign','reverse','now','../error/CamDigiKeyError','throw','certificate','sort','defineProperty','__esModule'];a2_0x5124=function(){return _0x5d0028;};return a2_0x5124();}var __awaiter=this&&this[a2_0x536c2f(0x1ae)]||function(_0x23142d,_0x959244,_0x5de10b,_0xe1543){function _0x3bac6d(_0x5c0f4a){return _0x5c0f4a instanceof _0x5de10b?_0x5c0f4a:new _0x5de10b(function(_0x508a66){_0x508a66(_0x5c0f4a);});}return new(_0x5de10b||(_0x5de10b=Promise))(function(_0x457903,_0x2da14b){const _0x132ed9=a2_0x4899;function _0x1744ac(_0x599536){try{_0x297f7b(_0xe1543['next'](_0x599536));}catch(_0x3b222d){_0x2da14b(_0x3b222d);}}function _0x33628e(_0x9bcb86){const _0x41cea9=a2_0x4899;try{_0x297f7b(_0xe1543[_0x41cea9(0x176)](_0x9bcb86));}catch(_0x208641){_0x2da14b(_0x208641);}}function _0x297f7b(_0x11f765){const _0xc9e386=a2_0x4899;_0x11f765[_0xc9e386(0x1ad)]?_0x457903(_0x11f765[_0xc9e386(0x194)]):_0x3bac6d(_0x11f765[_0xc9e386(0x194)])[_0xc9e386(0x19e)](_0x1744ac,_0x33628e);}_0x297f7b((_0xe1543=_0xe1543['apply'](_0x23142d,_0x959244||[]))[_0x132ed9(0x17d)]());});},__importDefault=this&&this['__importDefault']||function(_0x51e588){const _0x2da33c=a2_0x536c2f;return _0x51e588&&_0x51e588[_0x2da33c(0x17a)]?_0x51e588:{'default':_0x51e588};};Object[a2_0x536c2f(0x179)](exports,a2_0x536c2f(0x17a),{'value':!![]});const lokijs_1=__importDefault(require('lokijs')),crypto_1=__importDefault(require(a2_0x536c2f(0x189))),request_1=__importDefault(require(a2_0x536c2f(0x18d))),fs_1=__importDefault(require('fs')),InvalidCertificateChainError_1=__importDefault(require(a2_0x536c2f(0x193))),CamDigiKeyError_1=__importDefault(require(a2_0x536c2f(0x175))),api_1=require(a2_0x536c2f(0x19a));class CamDigiKeyMemoryCache{constructor(_0x1231e3){const _0x48fe6d=a2_0x536c2f;this[_0x48fe6d(0x17e)]=_0x1231e3,this[_0x48fe6d(0x1b1)]=new lokijs_1[(_0x48fe6d(0x195))](_0x48fe6d(0x1a6)),this[_0x48fe6d(0x180)]=this[_0x48fe6d(0x1b1)][_0x48fe6d(0x1b3)]('camdigikey_signer_certificates');}[a2_0x536c2f(0x19d)](){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x3d03ca=a2_0x4899,_0x36ce6d=Date[_0x3d03ca(0x174)](),_0x2356e7=this['_signerCertificate'][_0x3d03ca(0x19c)]({'validDate':{'$gt':new Date()}});if(_0x2356e7==null){const _0x5a4e52=yield this['getCertificateFromCamDigiKey'](),_0x47e8a6=_0x5a4e52[_0x3d03ca(0x1a9)],_0x588084={'certificate':_0x5a4e52[_0x3d03ca(0x17f)][0x0],'certificateChain':_0x5a4e52[_0x3d03ca(0x17c)],'validDate':new Date(_0x47e8a6['validTo'])};return this[_0x3d03ca(0x180)][_0x3d03ca(0x199)](_0x588084),new crypto_1[(_0x3d03ca(0x195))][(_0x3d03ca(0x190))](_0x588084[_0x3d03ca(0x177)]);}else return new crypto_1['default'][(_0x3d03ca(0x190))](_0x2356e7[_0x3d03ca(0x177)]);});}[a2_0x536c2f(0x18c)](){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x1a1f94=a2_0x4899,_0x25f3d0={'url':String(process['env']['CAMDIGIKEY_SERVER_BASED_URL'])+api_1[_0x1a1f94(0x198)][_0x1a1f94(0x18a)],'headers':{'Content-Type':_0x1a1f94(0x184)}};return process['env'][_0x1a1f94(0x1a4)]&&(_0x25f3d0[_0x1a1f94(0x1b2)]={'pfx':fs_1['default'][_0x1a1f94(0x1a0)](String(process['env'][_0x1a1f94(0x1a4)])),'passphrase':String(process[_0x1a1f94(0x1aa)][_0x1a1f94(0x182)])}),yield new Promise(_0x56825f=>{const _0x1df346=_0x1a1f94;request_1[_0x1df346(0x195)][_0x1df346(0x1b4)](_0x25f3d0,(_0x52e404,_0x2a12ee,_0x242154)=>{const _0x1e49c5=_0x1df346;if(!_0x52e404){if(_0x2a12ee[_0x1e49c5(0x1a3)]>=0xc8&&_0x2a12ee[_0x1e49c5(0x1a3)]<0x12c){if(_0x242154!=null){const _0x500d4=JSON[_0x1e49c5(0x18f)](_0x242154),_0x5a9324=[],_0x25691f={'cert_chain':_0x500d4[_0x1e49c5(0x1b0)],'cert_chain_str':_0x242154};for(let _0x656c11=0x0;_0x656c11<_0x500d4[_0x1e49c5(0x1b0)][_0x1e49c5(0x192)];_0x656c11++){_0x5a9324[_0x1e49c5(0x183)](new crypto_1[(_0x1e49c5(0x195))][(_0x1e49c5(0x190))](Buffer['from'](_0x500d4[_0x1e49c5(0x1b0)][_0x656c11])));}_0x5a9324[_0x1e49c5(0x173)]();if(this[_0x1e49c5(0x1a2)](this[_0x1e49c5(0x17e)],_0x5a9324)){const _0x5e4f11=new Date(_0x5a9324[0x0][_0x1e49c5(0x1ac)]);if(_0x5e4f11[_0x1e49c5(0x185)]()>Date['now']())return _0x56825f(Object[_0x1e49c5(0x172)](Object[_0x1e49c5(0x172)]({},_0x25691f),{'signer_cert':_0x5a9324[0x0]}));else throw new InvalidCertificateChainError_1[(_0x1e49c5(0x195))](_0x1e49c5(0x1ab));}else throw new InvalidCertificateChainError_1[(_0x1e49c5(0x195))](_0x1e49c5(0x1ab));}else return _0x56825f({});}throw new CamDigiKeyError_1[(_0x1e49c5(0x195))](_0x1e49c5(0x1af));}else throw new CamDigiKeyError_1['default'](_0x52e404[_0x1e49c5(0x1a7)]);});});});}[a2_0x536c2f(0x1a2)](_0x4e4bef,_0x5ef10a){const _0x1f3917=a2_0x536c2f;let _0x1131ec=0x0,_0x3df0b1=![];for(let _0x21c02c=0x0;_0x21c02c<_0x5ef10a[_0x1f3917(0x192)];_0x21c02c++){_0x3df0b1=![];for(let _0x1211b0=0x0;_0x1211b0<_0x5ef10a[_0x1f3917(0x192)];_0x1211b0++){if(this['compareTwoPrincipals'](_0x4e4bef,_0x5ef10a[_0x1211b0])){if(_0x5ef10a[_0x1211b0][_0x1f3917(0x1a5)](_0x4e4bef['publicKey'])){_0x1131ec++,_0x3df0b1=!![];break;}else return![];}else{if(this[_0x1f3917(0x19b)](_0x5ef10a[_0x21c02c],_0x5ef10a[_0x1211b0])){if(_0x5ef10a[_0x1211b0][_0x1f3917(0x1a5)](_0x5ef10a[_0x21c02c][_0x1f3917(0x18e)])){_0x1131ec++,_0x3df0b1=!![];break;}else return![];}}}if(!_0x3df0b1)return![];}return _0x1131ec===_0x5ef10a[_0x1f3917(0x192)];}['compareTwoPrincipals'](_0x1080a9,_0x2b36c6){const _0x192cf3=a2_0x536c2f,_0x315cdf=_0x1080a9[_0x192cf3(0x1a8)][_0x192cf3(0x18b)]('\x0a')[_0x192cf3(0x178)](),_0x52d4c7=_0x2b36c6[_0x192cf3(0x1a8)]['split']('\x0a')[_0x192cf3(0x178)]();if(_0x315cdf['length']!=_0x52d4c7['length'])return![];return _0x315cdf['every'](_0x1ac548=>_0x52d4c7['includes'](_0x1ac548));}}function a2_0x4899(_0x173a8e,_0x58cf8d){const _0x512446=a2_0x5124();return a2_0x4899=function(_0x489974,_0x5f5896){_0x489974=_0x489974-0x172;let _0x359a1a=_0x512446[_0x489974];return _0x359a1a;},a2_0x4899(_0x173a8e,_0x58cf8d);}exports['default']=CamDigiKeyMemoryCache;